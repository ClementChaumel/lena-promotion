---
import { db, Episode, Season, Brand, Collab, eq } from "astro:db";

const episodeId = Astro.props.episodeId;

console.log(episodeId);

const episode = (
  await db.select().from(Episode).where(eq(Episode.id, episodeId))
)[0];

console.log(episode);

// get All Collabs for this episode
const collabs = await db
  .select()
  .from(Collab)
  .where(eq(Collab.episodeId, episodeId));

const brands = [] as (typeof Brand)[];

for (let collab of collabs) {
  console.log(collab);
  const brand = await db
    .select({
      name: Brand.name,
      primaryColor: Brand.primaryColor,
      secondaryColor: Brand.secondaryColor,
      logo: Brand.logo,
    })
    .from(Brand)
    .where(eq(Brand.id, collab.brandId));

  brands.push(brand[0]);
}

console.log(brands);
---

<div class="episode">
  {
    collabs.map((collab, index) => (
      <div
        class="collab"
        style={`--primary-color: ${brands[index].primaryColor}; --secondary-color: ${brands[index].secondaryColor}; width: ${(collab.duration / episode.duration) * 100}%; left: ${
          (collab.timestamp / episode.duration) * 100
        }%`}
      >
        <div class="tooltip">
          <div class="tooltip-content">
            <div class="tooltip-header">
              <div class="tooltip-brand">
                <img class="logo" src={`${brands[index].logo}`} alt="" />
                <span>{brands[index].name}</span>
              </div>
              <span>
                {Math.floor(collab.duration / 60)}min {collab.duration % 60}s
              </span>
            </div>
            <div class="tooltip-title">{collab.description}</div>
          </div>
        </div>
      </div>
    ))
  }
</div>
<div class="runtime">
  <span>0:00</span>
  <span>{Math.floor(episode.duration / 60)}:{episode.duration % 60}</span>
</div>

<style>
  .episode {
    width: 100%;
    height: calc(2rem + 4px);
    border-radius: 99999px;
    background-color: #5e647220;
    box-shadow: inset 2px 5px 10px rgba(0, 0, 0, 0.25);
    position: relative;
  }

  @keyframes spin {
    0% {
      background-position-x: 300px;
    }

    100% {
      background-position-x: 498px;
    }
  }

  .collab {
    position: absolute;
    height: 2rem;
    top: 2px;
    border-radius: 99999px;
    background-color: var(--primary-color);
    background: repeating-linear-gradient(
      45deg,
      var(--primary-color),
      var(--primary-color) 10px,
      var(--secondary-color) 10px,
      var(--secondary-color) 20px
    );
    background-size: 1000px 200%;
    animation: spin 11s linear infinite;
    animation-play-state: paused;

    box-shadow: var(--shadow-elevation-high);

    &:hover {
      animation-play-state: running;

      .tooltip {
        visibility: visible;
        opacity: 1;
      }
    }

    &::before {
      inset: 0;
      position: absolute;
      border-radius: 5em;
      background-image: radial-gradient(
          ellipse,
          #ffffff30 20%,
          transparent 50%,
          transparent 200%
        ),
        linear-gradient(
          90deg,
          #404040 -10%,
          transparent 30%,
          transparent 70%,
          #404040 110%
        );
      box-shadow:
        inset 0 0.25em 0.75em rgba(0, 0, 0, 0.8),
        inset 0 -0.05em 0.2em rgba(255, 255, 255, 0.4),
        inset 0 -1px 3px #ffffff;
      background-blend-mode: overlay;
      background-repeat: no-repeat;
      background-size:
        200% 80%,
        cover;
      background-position: center 220%;
      mix-blend-mode: overlay;
      content: "";
    }

    &::after {
      content: "";
      inset: 0;
      position: absolute;
      border-radius: 5em;
      background: linear-gradient(
        180deg,
        #ffffff,
        #ffffff50 40%,
        transparent 80%
      );
      top: 1px;
      left: 5px;
      right: 5px;
      bottom: 0.7rem;
      mix-blend-mode: screen;
    }
  }

  .tooltip {
    position: absolute;
    bottom: 3rem;
    left: calc(50% - 150px);
    width: 300px;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    backdrop-filter: blur(5px) saturate(180%);
    -webkit-backdrop-filter: blur(5px) saturate(180%);
    background-color: rgba(255, 255, 255, 0.34);
    background-color: #b8f2e670;
    background-color: #b8f2e6a0;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.7);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    z-index: 100;
  }

  .tooltip-content {
    border-radius: 8px;
    padding: 16px;
  }

  .tooltip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  }

  .tooltip-brand {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 800;
  }

  .tooltip-brand img {
    height: 32px;
    object-fit: cover;
  }

  .tooltip-title {
    font-size: 14px;
    line-height: 20px;
    color: var(--paynes-gray);
  }

  .runtime {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    font-size: 14px;
    line-height: 20px;
    color: var(--paynes-gray);
  }
</style>
